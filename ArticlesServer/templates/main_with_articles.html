{% extends 'layout.html' %}


{% block body %}
    <style>
td.details-control {
    background: #0f9d58   no-repeat;
    cursor: pointer;
}
tr.shown td.details-control {
    background: red  no-repeat;
}
    </style>


<div class="row">

  <div id="admin" class="col s12">
      <table id="datatable" class="display" style="width:100%">
          <caption>
            <a id="FullWithFindingsButton"> Full read with findings </a>
            <a id="PartialWithFindingsButton"> Partial read with findings </a>
            <a id="PartialWithoutFindingsButton"> Partial read without findings </a>
            <a id="FullWithoutFindingsButton"> Full read without findings </a>

          </caption>
        <thead>
          <tr>
            <th></th>
            <th>Id</th>
            <th>Title</th>
            <th>Article Status</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
</div>


{% endblock %}

{% block scripts %}
    <script>
        const ENABLED_FullWithFindingsButton ='waves-light btn green darken-2';
        const DISABLED_FullWithFindingsButton ='waves-light btn green lighten-4';
        const ENABLED_PartialWithFindingsButton ='waves-light btn orange darken-2';
        const DISABLED_PartialWithFindingsButton ='waves-light btn orange lighten-4';
        const ENABLED_PartialWithoutFindingsButton ='waves-light btn yellow darken-2';
        const DISABLED_PartialWithoutFindingsButton ='waves-light btn yellow lighten-4';
        const ENABLED_FullWithoutFindingsButton ='waves-light btn red darken-2';
        const DISABLED_FullWithoutFindingsButton ='waves-light btn red lighten-4';
    </script>


    <script>
        function format ( d ) {
        // `d` is the original data object for the row
            return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
                '<tr>'+
                    '<td>Doi:</td>'+
                    '<td>'+d.doi+'</td>'+
                '</tr>'+
                '<tr>'+
                    '<td>Statuses:</td>'+
                    '<td>'+d.statuses+'</td>'+
                '</tr>'+
            '</table>';
          }



        var articlesData = {{ articles|tojson }};

        articlesData = articlesData.map(function (data) {
             data.statuses = data.statuses.map(
                    function (statusData) {
                        var result = '';
                        if (statusData[1] == 1)
                            result+= '<a class="waves-light btn-small yellow">To be checked';
                        else if (statusData[1] == 2)
                            result+= '<a class="waves-light btn-small green">Accepted'
                        else
                            result+= '<a class="waves-light btn-small red">Rejected'
                        result += '<div class="chip">' + statusData[0]+ '</div></a>'
                        return result;
                    }
                ).join(' ');
                return data;
        });

        $.fn.dataTable.ext.order['articleStatus'] = function  ( settings, col )
        {
            return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
                return articlesData[i].article_status;
            } );
        };
        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                var rowStatus = articlesData[dataIndex].article_status;
                if($("#FullWithFindingsButton").attr("class") == DISABLED_FullWithFindingsButton && rowStatus == 1)
                {
                    return false;
                }
                if($("#PartialWithFindingsButton").attr("class") == DISABLED_PartialWithFindingsButton && rowStatus == 2)
                {
                    return false;
                }
                if($("#PartialWithoutFindingsButton").attr("class") == DISABLED_PartialWithoutFindingsButton && rowStatus == 3)
                {
                    return false;
                }
                if($("#FullWithoutFindingsButton").attr("class") == DISABLED_FullWithoutFindingsButton &&  rowStatus == 4)
                {
                    return false;
                }
                return true;
            }
        );

        $(document).ready( function () {
            var table = $('#datatable')
                .DataTable(
                {
                    data : articlesData,
                    paging: false,
                    columns : [
                        {
                            "className":      'details-control',
                            "orderable":      false,
                            "data":           null,
                            "defaultContent": '<i class="material-icons">expand_more</i>'
                        },
                        {data: "id"},
                        {
                            data: "title",
                            render: function ( data, type, row, meta ) {
                              return  '<a class="action" href="'
                                  + Flask.url_for('main.view_doi', {'doi_id' : row.id})
                                  + '" >'
                                  + data + '</a>';
                            }
                        },
                        {
                            data: "article_status",
                            render: function ( data, type, row, meta ) {
                              var result = '<a style="width:90%" class="';
                              if (data == 1)
                              {
                                  result+=ENABLED_FullWithFindingsButton
                              }
                              if (data == 2)
                              {
                                  result+=ENABLED_PartialWithFindingsButton
                              }
                              if (data == 3)
                              {
                                  result+= ENABLED_PartialWithoutFindingsButton
                              }
                              if (data == 4)
                              {
                                  result += ENABLED_FullWithoutFindingsButton
                              }
                              result +='"></a>';
                              return result;
                            },
                            "orderDataType": "articleStatus"
                        },
                    ],
                    "order": [[1, 'asc']]
                }
            );

            // Add event listener for opening and closing details
            $('#datatable tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row( tr );

                if ( row.child.isShown() ) {
                    // This row is already open - close it
                    row.child.hide();
                    $(this).html('<i class="material-icons">expand_more</i>');
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child( format(row.data()) ).show();
                    $(this).html('<i class="material-icons">expand_less</i>');
                    tr.addClass('shown');
                }
            } );

            $('#FullWithFindingsButton').attr("class", ENABLED_FullWithFindingsButton);
            $('#FullWithFindingsButton').on('click', function () {
                if (this.className == ENABLED_FullWithFindingsButton)
                    this.className = DISABLED_FullWithFindingsButton;
                else
                    this.className = ENABLED_FullWithFindingsButton;
                table.draw()
            });
            $('#PartialWithFindingsButton').attr("class", ENABLED_PartialWithFindingsButton);
            $('#PartialWithFindingsButton').on('click', function () {
                if (this.className == ENABLED_PartialWithFindingsButton)
                    this.className = DISABLED_PartialWithFindingsButton;
                else
                    this.className = ENABLED_PartialWithFindingsButton;
                table.draw()
            });
            $('#PartialWithoutFindingsButton').attr("class", ENABLED_PartialWithoutFindingsButton);
            $('#PartialWithoutFindingsButton').on('click', function () {
                if (this.className == ENABLED_PartialWithoutFindingsButton)
                    this.className = DISABLED_PartialWithoutFindingsButton;
                else
                    this.className = ENABLED_PartialWithoutFindingsButton;
                table.draw()
            });
            $('#FullWithoutFindingsButton').attr("class", ENABLED_FullWithoutFindingsButton);
            $('#FullWithoutFindingsButton').on('click', function () {
                if (this.className == ENABLED_FullWithoutFindingsButton)
                    this.className = DISABLED_FullWithoutFindingsButton;
                else
                    this.className = ENABLED_FullWithoutFindingsButton;
                table.draw()
            });

        } );
    </script>
{% endblock %}

